# ITigrisTestTools
Custom test and db maintenance tools

## Split data by franchise

#### Общая информация
CRM для сетей оптик Optima имеет два варианта комплектации - Optima Light и Optima (Optima Complete). Наши африканские партнеры долгое время работали с системой Optima Light, но в процессе переговоров было решено переводить их на Optima Complete. Основная задача, необходимая для внедрения, - миграция данных в вид, совместимый с Optima Complete.

Любая Optima представляет собой multitenancy-приложение, взаимодействующее с независимыми датасорсами (базами данных). В случае Optima Light одной оптической сети соответствует одно приложение, в котором хранятся вместе данные по внутренним сетям общей сети. Общая сеть распределена на уровене одной африканской страны, внутренние сети - на локальном уровне (города).

Внутренние сети разделены по франшизам - пользователи одной из франшиз не имеют доступа к данным другой франшизы. Разные франшизы имеют разные контексты (это обеспечивается на уровне данных, например, каждый менеджер франшизы может независимо настроить список услуг, оказываемых по его франшизе). Отдельная логика существует для франшизы дистрибьютора, который занимается подтверждением заявок всех франшиз.

Таким образом, необходимо одну базу данных разделить на несколько, каждая база должна иметь только данные, относящиеся к своей франшизе, и минимально необходимый для совместимости контекст дистрибьютора. В Optima Complete нет дистрибьюторов и франшиз, так что после разделения они подлежат удалению, а контекст дистрибьютора предварительно приводится к контексту, совместимому с Optima Complete.

Не везде признак франшизы определяется универсальным образом, некоторые сущности имеют прямой признак франшизы, для некоторых он определяется через департамент сущности или через департамент заказа. Для некоторых сущностей признак франшизы не является обязательным, т. е. определенные значения могут быть доступны для всех франшиз.

Приведенная в репозитории функция вычищает из бд все лишние для этой франшизы данные (название франшизы подается на вход), мусорные данные и задает дефолтный контекст приложения.

#### Краткая схема разделения
- восстановить N экземпляров исходной базы (по числу франшиз);
- накатить на каждую базу соответствующий скрипт (входные параметры - имя франшизы, имя нового приложения);
- провести миграцию баз до актуальной версии Optima Complete.
